import Foundation

struct GuardGallivant {

    class Path {
        private var visited = [Coord: [Direction]]()
        private(set) var containsLoop = false

        func insertVisit(coord: Coord, direction: Direction) {
            guard !isLoopIfVisited(coord: coord, direction: direction) else {
                containsLoop = true
                return
            }

            visited.collate(direction, using: coord)
        }

        func isLoopIfVisited(coord: Coord, direction: Direction) -> Bool {
            visited[coord]?.contains(direction) ?? false
        }

        func countVisitedLocations() -> Int { visited.keys.count }

    }

    static func solve() {
        let grid = Grid<Character>(string: input)
        let index = grid.index()
        let startLocation = index["^"]!.first!

        func walk(grid: Grid<Character>) -> Path {
            let path = Path()
            var direction: Direction = .north
            var location = startLocation

            while grid.size.contains(location) && !path.containsLoop {
                let ahead = direction.advance(coord: location)
                if grid[ahead] == "#" {
                    direction = direction.turnedRight()
                    continue
                }

                path.insertVisit(coord: location, direction: direction)
                location = ahead
            }

            return path
        }

        // Walk the grid and count the number of distinct locations visited
        // (some locations may be visited more than once).

        let s1 = walk(grid: grid).countVisitedLocations()

        // Enumerate the possible locations for an obstacle, try each and
        // count how many create a loop.

        let s2 = index["."]!.count { obstacle in
            grid[obstacle] = "#"
            let path = walk(grid: grid)
            grid[obstacle] = "."

            return path.containsLoop
        }

        printSolutions(s1, s2)
    }

}

extension GuardGallivant {

    static let input = """
.........#...#................................#.........#............#.....#....#.....................................#...........
............................................................................................#...............#.......#.............
....#.......#......................................#.........................#..#....#....#.........#.............................
............##..#............#........................#........#........#.......#...........................#................#....
..................................#.............#....#..........................#................#..#....##........#..............
..................##.#...#....#...................##.....#.................#......##.....................##............#..........
..........#..................................#....................................................................................
......#...........#.......................................#........#........................#........#............................
..................#................................#........................#.............................#.......................
.............#............................................................................................##.................#....
........#..............................................................................................#..............#.#.......#.
..#...........#..............#..............#..#.....#.......#......#.......................#....#...................##..........#
..............##................................#..............##....................#...#........................................
......................#.................#.......#.......##.##....................................#................................
...........#...#.#..................#...#.....................................................................#...................
.....#....#...#..............................................................................................#.......#............
...............................#...........#.#.............#.........#.....................................#.#....................
........#...........#.......#............................#.....#.............................#.........................#..........
...................................................#...........#.....#..#....#.............#.....#..#..#.............#............
..............#.........#..#..........#.#.......................#...................................#.............................
..#.............#..#..#.#...........#...................................................#...........................#...........#.
........##....##..........................................................................#.......................................
.......................................................#.......#.............................#...................#........#.......
#.....#.#......#...............................................................#..........#........#..............................
.#.#............#..............#..........................#.#.....................................................#...............
.................#...#........#....#.....#...#...................................#....#.................#..........#...#.#...#....
...#..##........................#..#..................................................................................#.......#...
.................#...#.#..................................................#..#........#.................#...................#.....
.......................#.......#....................#......................................#...............................#......
...............................................................................................................................#..
...........##............................#....................#...................................................................
..#........................................#..#.............................#............................#........................
..#.#....#..................................#...................................................................................#.
.................#...#...............#..........#..............................#...#..............................#.#..#..........
............#..........#..........#...................................#.....#....................#................##.............#
....#...........#.......#......................................#........................................#........#......#...#.....
.............#.....#...................#....#.....................................................................................
.....................#.................................#.#...................#.......#.#...............#..........................
........#..............#.......#.............#...........................................................#........#..............#
............#............................................#.......##................#..............................................
...............................#..................................................................................................
#....................#......#.......................#..........#.........................#................#...............#..#...#
..................................................#.....#...........#...#..#......#...........................#...................
............#......................#.....#.........#....................................................................#....#....
.......#...................#...#...........................#.......#......#......................................#.....#..........
.................................................#.............#....................................#.............................
......#.................#.............................................................................#..##.......................
....#..............................................#..............#..........#.......#....#............................#..........
........#....#............#....#.................#........................................................#.....#.................
..#......................#.......................................................#................................................
.#.....................#..........................................................#.............................#.................
.............#..............#.#.....#.........................................#...............................#.........#.........
.............................................................................#............................#....#...#..............
#.#.#...................................................................#...........................................#.........#...
..................................................#.#............#..#...#..............#.....#....................................
......#..................................#............................##.........................................#................
..#....................................#............#.........#.........#...........#.....#..............................#........
......................................#.............#..................#.................#..........................##............
...............#.#........#.......................#..........#...............................#.............................#.#....
.................#....................................................................................#...........................
#...............................................#.#........#...#...................#............#.................#......#.#......
................#........................#......#.............................................#.#..............#....#.............
.......#..........#..........................#......#.............................................................................
....#.......#.................................................#..............#...........#.....#............#............#........
.....................#...................................#...............................................................#........
#..........................#..#...........................................#...............#............#............#.............
.............................#...................................#...#.......................................#......#.............
............#........#.................................................#.................#...................#....................
.........................................#................#.....................................#.................................
...........................................................................................#.....................#................
.....................#.........#..#.#......................................................#........#.............................
..#......#.........#.#...................................................#......................#.................................
.#...........#.........................................................................................#.....................#....
..........#....##.#..#..........#........#.#.................................#.....................#..............................
.....#........#.......#....#...........#...................#...............#..#....#..............................#..............#
.......#..............................#............#.................................................#........#................#..
...............................#..............................................#...................................................
#..............................................................#.........................................................#........
.......#....................................................#..............................#..................#..........##.......
.......................................#...............................................^.............#............................
..#...........#.........#............................#...................................#.#.......###.....#......................
........#............................................................................................................#............
...#...#...........#.................................................................#...#.......#........#.......................
...............#.....................................#..........#.......#.#.....#.#..................#............................
.....#..#..............#.#.......................#.................................................................#..............
#.....#.........................................#..##....#..........................#...................#..#......#........#......
...................##................#..#......................................#.....#............................................
....#...............................................................................................#...........................#.
....#..........#....#........................#....................................................................................
..................#.....................................................#.....................................#...................
...........................#......#.......................................................................#..............#........
...............#....................#...#...#.......#................#.......#.......#............................................
#.....##......#.............................................#...#.................................#.................#....#..##..#.
..........#.......................................#..................................#...#....#......................#............
......#................#.#........#....#......##.........#........................................#...............................
......#...#............#...#.........................................................#....#.....#..............#..................
.........................#...............#........#...#......#....................................................#..#.#..........
...##............#........#.#.........................#.............................#............#..............#.................
.......#.........#..............................#...................................#.......................#.#...................
#..........#.............#..............................................#.....................................................#...
........#..#...#.....................................#............................................................................
..................#...............................#..........................................#.............#..............#..#....
....#.#..#...#............................#..............#...#..........#......#....#.....................#..........#......#.....
................#..............#........................#......#..............#.......................##..........................
..........#.....#.............................................#.......#...........................................#...............
.........#....#........#............#...............#.............................................................................
...........#..#..........#..............#..........#......#.......................................................................
..........#....................#........................................#.....#..................#..#.#..#...#.....#..............
........#...........#...#..................##.........#......................#...#............#......................#............
...................................................#........................#.....#.............#.................................
........#................#..........................#.#...#......#........................................#.......................
.............#.........................................##....................#...................#.#..................#...........
..................#.............................................#...............................................................#.
.....#............#................#..............................#...##....#...#.................................................
#.......................###........#..............#.....#.............#...............#.............#......................#......
...........#.............................#........................#.........................................................#.....
............#.....#.....#...#....#........#...............................#.....................#..................#....#.........
...............#.#..................................#.................#.#......#...........#...#................#.................
.....#............................................#.....#...............#.....#.............#.......#..........#..................
.....................................#................................................#.........#..#..............................
.....................#...............................................#.#...........#........#.....................................
.............................................#....................#.............#......................#..........................
......................................#.........#.........................##........#................#...............#............
........................#.....#.....................................#....#........#......#..............#.......##...........#.#..
....................#........................................#.........#.........#......#....#............#...........#...........
...........##......#...........#................#.......##.....#........#.........#...........................................#...
...................#...#....#.............#..#......................................................#............#................
....#.........................#....#..................#..............#.............#...................................#..........
..................................#.......#.....................#.................................................................
.............................................#......#.......................................................#.....................
"""

}
